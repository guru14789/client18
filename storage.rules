rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper to check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper to check ownership based on path
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper to get memory data from Firestore
    function getMemoryData(memoryId) {
      return firestore.get(/databases/(default)/documents/memories/$(memoryId)).data;
    }

    // Helper to check family membership
    function isFamilyMember(familyId) {
      return isSignedIn() && request.auth.uid in firestore.get(/databases/(default)/documents/families/$(familyId)).members;
    }

    // Videos
    match /videos/{userId}/{memoryId} {
      allow write: if isOwner(userId);
      allow read: if isSignedIn() && (
        isOwner(userId) || 
        (getMemoryData(memoryId.replace('.mp4', '')).status == 'published' && 
         isFamilyMember(getMemoryData(memoryId.replace('.mp4', '')).familyIds[0]))
      );
    }

    // Thumbnails
    match /thumbnails/{userId}/{memoryId} {
      allow write: if isOwner(userId);
      allow read: if isSignedIn() && (
        isOwner(userId) || 
        (getMemoryData(memoryId.replace('.jpg', '')).status == 'published' && 
         isFamilyMember(getMemoryData(memoryId.replace('.jpg', '')).familyIds[0]))
      );
    }

    // Profiles
    match /profiles/{userId}/{allPaths=**} {
      allow write: if isOwner(userId);
      allow read: if isSignedIn();
    }
  }
}
